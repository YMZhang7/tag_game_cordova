// const { find } = require('../platforms/ios/www/cordova_plugins');

var http = require('http').createServer();
var io=require('socket.io')(http);


http.listen(3000, () => {
    console.log("server started");
});

var players = [];
var pace_length = 5;



io.sockets.on('connection',function(socket){
    console.log('one player connected'); // server side
    socket.on('requestPlayers', () => {
        socket.emit('players', players);
    });

    socket.on('newPlayer', (data) => {
        // socket.broadcast.emit('createNewPlayer', data); // for current players to load new player
        players.push(data);
        io.emit('createNewPlayer', players);
    });

    socket.on('goDown', (data)=>{
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == data){
                index = i;
                break;
            }
        }
        if (players[index]['location_y'] <= 90-pace_length){
            players[index]['location_y'] += pace_length;
        } else {
            players[index]['location_y'] = 90;
        }
        if (pace_length == 5){
            io.emit('goDown', data);
        } else {
            io.emit('goDownRocket', data);
        }
    });
    socket.on('goUp', (data)=>{
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == data){
                index = i;
                break;
            }
        }
        if (players[index]['location_y'] >= pace_length){
            players[index]['location_y'] -= pace_length;
        } else {
            players[index]['location_y'] = 0;
        }
        if (pace_length == 5){
            io.emit('goUp', data);
        } else {
            io.emit('goUpRocket', data);
        }
    });
    socket.on('goLeft', (data)=>{
        // let index = findIndex(data);
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == data){
                index = i;
                break;
            }
        }
        if (players[index]['location_x'] >= pace_length){
            players[index]['location_x'] -= pace_length;
        } else {
            players[index]['location_x'] = 0;
        }
        if (pace_length == 5){
            io.emit('goLeft', data);
        } else {
            io.emit('goLeftRocket', data);
        }
    });
    socket.on('goRight', (data)=>{
        // let index = findIndex(data);
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == data){
                index = i;
                break;
            }
        }
        if (players[index]['location_x'] <= 90-pace_length){
            players[index]['location_x'] += pace_length;
        } else {
            players[index]['location_x'] = 90;
        }
        if (pace_length == 5){
            io.emit('goRight', data);
            console.log('go right');
        } else {
            io.emit('goRightRocket', data);
        }
    });

    socket.on('caught', (name)=>{
        // inform other players to update players list
        io.emit('playerCaught', name);
        console.log('caught');
    });

    socket.on('playerQuit', (data) => {
        // let index = findIndex(data);
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == data){
                index = i;
                break;
            }
        }
        players.splice(index, 1);
        io.emit('playerQuit', data);
    });

    socket.on('updatePlayer', (player) => {
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == player['name']){
                index = i;
                break;
            }
        }
        players[index] = player;
        socket.broadcast.emit('updatePlayer', player);
    });

    socket.on('useIceCube', (name) => {
        // let index = findIndex(name);
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == name){
                index = i;
                break;
            }
        }
        players[index]['iceCube'] -= 1;
        socket.broadcast.emit('updatePlayer', players[index]);
    });

    socket.on('paralysePlayer', (data) => {
        io.emit('paralysePlayer', data);
    });

    socket.on('unfrozen', (data) => {
        io.emit('unfrozen', data);
    });

    socket.on('useShields', (name) => {
        // let index = findIndex(name);
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == name){
                index = i;
                break;
            }
        }
        players[index]['shields'] -= 1;
        socket.broadcast.emit('useShields', players[index]);
    });

    socket.on('useRocket', (name) => {
        // let index = findIndex(name);
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == name){
                index = i;
                break;
            }
        }
        players[index]['rockets'] -= 1;
        pace_length = 10;
        socket.broadcast.emit('updatePlayer', players[index]);
    });

    socket.on('rocketStop', () => {
        pace_length = 5;
    });

    socket.on('useCloak', (name) => {
        let index = 0;
        for (let i = 0; i < players.length; i++){
            if (players[i]['name'] == name){
                index = i;
                break;
            }
        }
        players[index]['invisibilityCloak'] -= 1;
        socket.broadcast.emit('invisible', name);
    });

    socket.on('invisibilityStop', (name) => {
        io.emit('invisibilityStop', name);
    });
});

io.sockets.on('disconnection', function(){
    console.log('player logged out')
});