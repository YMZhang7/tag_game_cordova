var http = require('http').createServer();
var io=require('socket.io')(http);


// http.on('listening', function(){
//     console.log('server is running');
// });

http.listen(8000, () => {
    console.log("server started");
});

var players = [];
var pace_length = 5;

io.sockets.on('connection',function(socket){
    console.log('one player connected'); // server side
    socket.on('requestPlayers', () => {
        socket.emit('players', players);
    });
    socket.on('newPlayer', (data) => {
        // socket.broadcast.emit('createNewPlayer', data); // for current players to load new player
        players.push(data);
        io.emit('createNewPlayer', players);
    });
    socket.on('goDown', (data)=>{
        if (players[data]['location_y'] <= 90-pace_length){
            players[data]['location_y'] += pace_length;
        } else {
            players[data]['location_y'] = 90;
        }
        if (pace_length == 5){
            io.emit('goDown', data);
        } else {
            io.emit('goDownRocket', data);
        }
    });
    socket.on('goUp', (data)=>{
        if (players[data]['location_y'] >= pace_length){
            players[data]['location_y'] -= pace_length;
        } else {
            players[data]['location_y'] = 0;
        }
        if (pace_length == 5){
            io.emit('goUp', data);
        } else {
            io.emit('goUpRocket', data);
        }
    });
    socket.on('goLeft', (data)=>{
        if (players[data]['location_x'] >= pace_length){
            players[data]['location_x'] -= pace_length;
        } else {
            players[data]['location_x'] = 0;
        }
        if (pace_length == 5){
            io.emit('goLeft', data);
        } else {
            io.emit('goLeftRocket', data);
        }
    });
    socket.on('goRight', (data)=>{
        if (players[data]['location_x'] <= 90-pace_length){
            players[data]['location_x'] += pace_length;
        } else {
            players[data]['location_x'] = 90;
        }
        if (pace_length == 5){
            io.emit('goRight', data);
        } else {
            io.emit('goRightRocket', data);
        }
    });

    socket.on('caught', (index)=>{
        // inform other players to update players list
        io.emit('playerCaught', index);
        console.log('caught');
    });

    socket.on('playerQuit', (data) => {
        players.splice(data, 1);
        io.emit('playerQuit', data);
    });

    socket.on('updatePlayer', (player) => {
        players[player['index']] = player;
        socket.broadcast.emit('updatePlayer', player);
    });

    socket.on('useIceCube', (index) => {
        players[index]['iceCube'] -= 1;
        socket.broadcast.emit('updatePlayer', players[index]);
    });

    socket.on('paralysePlayer', (data) => {
        io.emit('paralysePlayer', data);
    });

    socket.on('unfrozen', (data) => {
        io.emit('unfrozen', data);
    });

    socket.on('useShields', (index) => {
        players[index]['shields'] -= 1;
        socket.broadcast.emit('updatePlayer', players[index]);
    });

    socket.on('useRocket', (index) => {
        players[index]['rockets'] -= 1;
        pace_length = 10;
        socket.broadcast.emit('updatePlayer', players[index]);
    });

    socket.on('rocketStop', () => {
        pace_length = 5;
    });

    socket.on('useCloak', (index) => {
        players[index]['invisibilityCloak'] -= 1;
        socket.broadcast.emit('invisible', index);
    });

    socket.on('invisibilityStop', (index) => {
        io.emit('invisibilityStop', index);
    });
});

io.sockets.on('disconnection', function(){
    console.log('player logged out')
});